# IaC / Ansible / Project / AWX

Setup AWX on a Kubernetes cluster.
This project wraps the default AWX's Ansible project and customize its deployment.

## Usage

### Requirements

* A running Kubernetes cluster
* A minimal inventory with a group named `awx_clusters`:

```yaml
awx_clusters:
    vars:
        awx_version: "9.3.0"                            # AWX tag (version)
        awx_inventory: "/tmp/awx-inventory"             # **Local** (Ansible controller) path to AWX inventory (will be generated)
        awx_repository: "/tmp/awx"                      # **Local** (Ansible controller) path to AWX git repository (will be cloned and checkout)
        awx_sidecar: "awx.istio.yml.j2"                 # Misc. resources definition for AWX (e.g. Istio resources)
        awx_namespace: "awx"                            # Project namespace
        awx_storageclass: "rbd-sc"                      # Storage class name (for PostgreSQL)
        awx_ingressgateway: "istio-ingressgateway"      # Ingress gateway name
        awx_gateway: "awx-gw"                           # AWX gateway name
        awx_gateway_hosts:                              # AWX gateway host filtering (inclusive)
        - "awx.dt.ept.lu"
        awx_virtualservice: "awx-vs"                    # AWX virtual service name
        awx_database: "awx"                             # AWX database name
    hosts:
        awx-master-01.dt.ept.lu:                        # AWX clusters hosts (**one** host per AWX / K8S cluster)
```

---

## Playbook `main.yml`

This playbook will deploy AWX side resources, and then clone and template the official AWX project.
AWX installation itself should be done by calling Ansible a second time from (see section **Playbook install.yml**)

* Template AWX inventory on the Ansible controller
* Clone AWX on the Ansible controller
* Install PostgreSQL on the Kubernetes cluster(s) (Bitnami's HA flavour)
* Install AWX sidecars (e.g. Istio gateway and virtual service)

### Tags

|Tag|Description|
|---|-----------|
|`setup`|deploy AWX side resources and prepare the official project installation|

---

## Playbook `install.yml`

This playbook is located at `{{ awx_repository }}/installer/install.yml` and comes with the official AWX project repository.
It requires an inventory file, which is generated by `main.yml` (see previous section) at `{{ awx_inventory }}`.

Run example: `ansible-playbook /tmp/awx-inventory.ini install.yml`
