- hosts:
    - awx_clusters
  
  tasks:

  - name: Debug
    debug:
      msg:
        - "host        : {{ inventory_hostname }}"
        - "user        : {{ ansible_user }}"
        - "become      : {{ ansible_become | lower }}"
        - "become_user : {{ ansible_user_id }}"
        - "key file    : {{ ansible_private_key_file }}"
        - "python      : {{ ansible_python_interpreter }}"
    tags:
      - debug


  - name: Set SSH key path fact
    set_fact:
      ssh_key: "{{ansible_private_key_file  }}"
    tags:
      - setup


  - name: Clone AWX
    shell: |
      if [ ! -d {{ awx_repository | default('/tmp/awx') }} ]; then git clone https://github.com/ansible/awx.git {{ awx_repository | default('/tmp/awx') }}; fi
      cd {{ awx_repository | default('/tmp/awx') }}
      git checkout tags/{{ awx_version }}
    delegate_to: localhost
    tags:
      - setup


  - name: Template AWX installer inventory
    template:
      src: "inventories/inventory-{{ awx_version }}.ini.j2"
      dest: "{{ awx_inventory | default('/tmp/awx-inventory.ini') }}"
    delegate_to: localhost
    tags:
      - setup


  - name: Create AWX namespace
    shell:
      kubectl create namespace "{{ awx_namespace }}"
    register: _create_namespace
    failed_when:
      - _create_namespace.rc != 0 and "AlreadyExists" not in _create_namespace.stderr
    tags:
      - setup


  - name: Collect installed Helm charts
    shell: >
      helm -n {{ awx_namespace }} list -o json
    register: _installed_charts
    tags:
      - setup
  

  - name: SetPostgreSQL's Helm action
    set_fact:
      helm_action: "{% if 'postgresql' in _installed_charts.stdout | from_json | map(attribute='name') | list %}upgrade{% else %}install{% endif %}"
    tags:
      - setup


  - name: Create PostgreSQL's Helm values
    tempfile:
      state: file
    register: _postgresql_values
    tags:
      - setup


  - name: Template PostgreSQL's Helm values
    template:
      src: postgresql.values.yml.j2
      dest: "{{ _postgresql_values.path }}"
    tags:
      - setup


  - name: Install or upgrade PostgreSQL (Helm)
    shell:
      helm {{ helm_action }} "postgresql" bitnami/postgresql-ha -n {{ awx_namespace }} -f {{ _postgresql_values.path }}
    when:
      - ""
    tags:
      - setup


  - name: Apply AWX networking (sidecar) manifest
    k8s:
      state: present
      definition: "{{ lookup('template', awx_sidecar) }}"
    when:
      - awx_sidecar is defined
    tags:
      - setup


  - name: Clean PostgreSQL's Helm values
    file:
      path: "{{ _postgresql_values.path }}"
      state: absent
    tags:
      - setup
